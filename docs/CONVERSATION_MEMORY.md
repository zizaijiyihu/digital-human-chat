# å¯¹è¯è®°å¿†åŠŸèƒ½è¯´æ˜

## æ¦‚è¿°

æ•°å­—äººå¯¹è¯ç³»ç»Ÿç°å·²æ”¯æŒ**å¤šè½®å¯¹è¯è®°å¿†**åŠŸèƒ½ï¼ŒAI å¯ä»¥è®°ä½ä¹‹å‰çš„å¯¹è¯å†…å®¹ï¼Œå®ç°è¿ç»­çš„ä¸Šä¸‹æ–‡å¯¹è¯ã€‚

## åŠŸèƒ½ç‰¹æ€§

### 1. ä¼šè¯ç®¡ç†

- **è‡ªåŠ¨ç”Ÿæˆä¼šè¯ ID**ï¼šé¡µé¢åŠ è½½æ—¶è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€ä¼šè¯æ ‡è¯†
- **ä¼šè¯éš”ç¦»**ï¼šä¸åŒä¼šè¯çš„å¯¹è¯å†å²ç›¸äº’ç‹¬ç«‹
- **åˆ›å»ºæ–°ä¼šè¯**ï¼šç‚¹å‡»"â• æ–°ä¼šè¯"æŒ‰é’®åˆ›å»ºæ–°ä¼šè¯
- **æ¸…ç©ºå†å²**ï¼šç‚¹å‡»"ğŸ—‘ï¸ æ¸…ç©ºå†å²"æŒ‰é’®æ¸…ç©ºå½“å‰ä¼šè¯çš„å¯¹è¯è®°å½•

### 2. å¯¹è¯å†å²å­˜å‚¨

- **å­˜å‚¨æ–¹å¼**ï¼šå†…å­˜å­—å…¸å­˜å‚¨ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ Redis æˆ–æ•°æ®åº“ï¼‰
- **å†å²é™åˆ¶**ï¼šæ¯ä¸ªä¼šè¯æœ€å¤šä¿ç•™ **20 æ¡æ¶ˆæ¯**ï¼ˆé¿å… token è¿‡å¤šï¼‰
- **è‡ªåŠ¨ä¿å­˜**ï¼šæ¯æ¬¡å¯¹è¯åè‡ªåŠ¨ä¿å­˜ç”¨æˆ·æ¶ˆæ¯å’Œ AI å“åº”

### 3. ä¸Šä¸‹æ–‡æ³¨å…¥

- **å®Œæ•´æ¶ˆæ¯åˆ—è¡¨**ï¼šç³»ç»Ÿæç¤ºè¯ + å†å²å¯¹è¯ + å½“å‰è§†é¢‘
- **å†å²æ ¼å¼**ï¼š`{'role': 'user'|'assistant', 'content': '...'}`
- **è§†é¢‘æ‘˜è¦**ï¼šç”¨æˆ·è§†é¢‘å­˜å‚¨ä¸ºæ–‡æœ¬æ‘˜è¦ï¼ˆ"ç”¨æˆ·ä¸Šä¼ äº†è§†é¢‘ç‰‡æ®µ"ï¼‰è€Œéå®Œæ•´ base64

## ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯ï¼šè¯­éŸ³æ•™å­¦å¯¹è¯

**ç¬¬ä¸€è½®å¯¹è¯ï¼š**
```
ç”¨æˆ·è§†é¢‘ï¼š[æ¼”è®²ç‰‡æ®µ]
AI å“åº”ï¼šä½ çš„å¼€åœºç™½ä¸é”™ï¼Œä½†æ˜¯ç¼ºå°‘çœ¼ç¥äº¤æµã€‚å»ºè®®åœ¨æ¼”è®²æ—¶å¤šçœ‹è§‚ä¼—ã€‚
```

**ç¬¬äºŒè½®å¯¹è¯ï¼ˆå¸¦è®°å¿†ï¼‰ï¼š**
```
ç”¨æˆ·è§†é¢‘ï¼š[æ”¹è¿›åçš„æ¼”è®²ç‰‡æ®µ]
ç³»ç»Ÿæç¤ºè¯ + å†å²å¯¹è¯ï¼ˆåŒ…å«ç¬¬ä¸€è½®ï¼‰+ å½“å‰è§†é¢‘
â†“
AI å“åº”ï¼šå¾ˆå¥½ï¼è¿™æ¬¡ä½ çš„çœ¼ç¥äº¤æµæ”¹å–„äº†å¾ˆå¤šã€‚ç°åœ¨æˆ‘ä»¬æ¥ç»ƒä¹ æ‰‹åŠ¿åŠ¨ä½œã€‚
         ï¼ˆAI è®°ä½äº†ä¹‹å‰æŒ‡å‡ºçš„é—®é¢˜ï¼‰
```

**ç¬¬ä¸‰è½®å¯¹è¯ï¼ˆç»§ç»­è®°å¿†ï¼‰ï¼š**
```
ç”¨æˆ·è§†é¢‘ï¼š[ç»ƒä¹ æ‰‹åŠ¿çš„ç‰‡æ®µ]
ç³»ç»Ÿæç¤ºè¯ + å†å²å¯¹è¯ï¼ˆåŒ…å«å‰ä¸¤è½®ï¼‰+ å½“å‰è§†é¢‘
â†“
AI å“åº”ï¼šä½ çš„æ‰‹åŠ¿å¾ˆè‡ªç„¶ï¼ç»“åˆåˆšæ‰ç»ƒä¹ çš„çœ¼ç¥äº¤æµï¼Œæ•´ä½“æ•ˆæœæå‡äº†å¾ˆå¤šã€‚
         ï¼ˆAI è®°ä½äº†çœ¼ç¥äº¤æµå’Œæ‰‹åŠ¿ç»ƒä¹ çš„å†…å®¹ï¼‰
```

## æŠ€æœ¯å®ç°

### åç«¯ API

#### å¯¹è¯å†å²ç®¡ç†å‡½æ•°

```python
# è·å–ä¼šè¯çš„å¯¹è¯å†å²
get_conversation_history(session_id) -> List[Dict]

# æ·»åŠ ä¸€æ¡æ¶ˆæ¯åˆ°å¯¹è¯å†å²
add_to_conversation_history(session_id, role, content)

# æ¸…ç©ºä¼šè¯çš„å¯¹è¯å†å²
clear_conversation_history(session_id)
```

#### è§†é¢‘å¯¹è¯ APIï¼ˆ`/api/video-auto-chat-with-tts`ï¼‰

**è¯·æ±‚å‚æ•°ï¼š**
- `videos`: è§†é¢‘æ–‡ä»¶ï¼ˆæ”¯æŒå¤šä¸ªç‰‡æ®µï¼‰
- `session_id`: ä¼šè¯ IDï¼ˆæ–°å¢ï¼‰

**å¤„ç†æµç¨‹ï¼š**
1. æ¥æ”¶ `session_id` å‚æ•°
2. ä»å†…å­˜ä¸­è·å–è¯¥ä¼šè¯çš„å†å²å¯¹è¯
3. æ„å»ºå®Œæ•´æ¶ˆæ¯åˆ—è¡¨ï¼š
   ```python
   messages = [
       {'role': 'system', 'content': system_prompt},
       ...history,  # å†å²å¯¹è¯
       {'role': 'user', 'content': [video]}  # å½“å‰è§†é¢‘
   ]
   ```
4. è°ƒç”¨ Qwen3-Omni-Flash è¿›è¡Œè§†é¢‘ç†è§£
5. ä¿å­˜å¯¹è¯åˆ°å†å²ï¼š
   ```python
   add_to_conversation_history(session_id, 'user', 'ç”¨æˆ·ä¸Šä¼ äº†è§†é¢‘ç‰‡æ®µ')
   add_to_conversation_history(session_id, 'assistant', text_response)
   ```
6. æµå¼ TTS åˆæˆå¹¶è¿”å›

#### æ–°å¢ç®¡ç† API

**1. è·å–ä¼šè¯å†å²**
```
GET /api/conversation/history?session_id=xxx

å“åº”ï¼š
{
    "success": true,
    "session_id": "session_1234567890_abc",
    "count": 6,
    "history": [
        {"role": "user", "content": "ç”¨æˆ·ä¸Šä¼ äº†è§†é¢‘ç‰‡æ®µ"},
        {"role": "assistant", "content": "...AI å“åº”..."},
        ...
    ]
}
```

**2. æ¸…ç©ºä¼šè¯å†å²**
```
POST /api/conversation/clear
Body: {"session_id": "session_1234567890_abc"}

å“åº”ï¼š
{
    "success": true,
    "session_id": "session_1234567890_abc",
    "message": "å¯¹è¯å†å²å·²æ¸…ç©º"
}
```

**3. è·å–æ‰€æœ‰ä¼šè¯åˆ—è¡¨**
```
GET /api/conversation/sessions

å“åº”ï¼š
{
    "success": true,
    "count": 3,
    "sessions": [
        {
            "session_id": "session_1234567890_abc",
            "message_count": 6,
            "last_update": "N/A"
        },
        ...
    ]
}
```

### å‰ç«¯å®ç°

#### ä¼šè¯ç®¡ç†

```javascript
// ç”Ÿæˆä¼šè¯ ID
let currentSessionId = generateSessionId();

function generateSessionId() {
    return `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
}

// åˆ›å»ºæ–°ä¼šè¯
function createNewSession() {
    currentSessionId = generateSessionId();
    // æ¸…ç©ºèŠå¤©è®°å½• UI
    chatLog.innerHTML = '<div class="empty-hint">æš‚æ— å¯¹è¯è®°å½•</div>';
    showStatus('å·²åˆ›å»ºæ–°ä¼šè¯', 'success');
}

// æ¸…ç©ºå½“å‰ä¼šè¯å†å²
async function clearCurrentSession() {
    const response = await fetch('/api/conversation/clear', {
        method: 'POST',
        body: JSON.stringify({ session_id: currentSessionId })
    });
    // æ¸…ç©ºèŠå¤©è®°å½• UI
    chatLog.innerHTML = '<div class="empty-hint">æš‚æ— å¯¹è¯è®°å½•</div>';
}
```

#### è§†é¢‘ä¸Šä¼ æ—¶é™„åŠ ä¼šè¯ ID

```javascript
const formData = new FormData();
formData.append('session_id', currentSessionId);  // æ·»åŠ ä¼šè¯ ID
formData.append('videos', videoBlob, 'video.webm');
```

## é…ç½®å‚æ•°

### å†å²é•¿åº¦é™åˆ¶

åœ¨ `app.py` ä¸­ä¿®æ”¹ï¼š

```python
# é™åˆ¶å†å²é•¿åº¦ï¼ˆä¿ç•™æœ€è¿‘ 20 æ¡ï¼Œé¿å… token è¿‡å¤šï¼‰
MAX_HISTORY = 20  # å¯è°ƒæ•´æ­¤å€¼
if len(conversation_history[session_id]) > MAX_HISTORY:
    conversation_history[session_id] = conversation_history[session_id][-MAX_HISTORY:]
```

**å»ºè®®å€¼ï¼š**
- è½»é‡å¯¹è¯ï¼š10-15 æ¡
- æ·±åº¦æ•™å­¦ï¼š20-30 æ¡
- é•¿æ—¶é—´å¯¹è¯ï¼š30-50 æ¡ï¼ˆæ³¨æ„ token é™åˆ¶ï¼‰

### å­˜å‚¨ä¼˜åŒ–

**å½“å‰å®ç°ï¼ˆå†…å­˜å­˜å‚¨ï¼‰ï¼š**
```python
conversation_history = {}  # å†…å­˜å­—å…¸
```

**ç”Ÿäº§ç¯å¢ƒå»ºè®®ï¼ˆRedisï¼‰ï¼š**
```python
import redis

redis_client = redis.Redis(host='localhost', port=6379, db=0)

def get_conversation_history(session_id):
    data = redis_client.get(f'session:{session_id}')
    return json.loads(data) if data else []

def add_to_conversation_history(session_id, role, content):
    history = get_conversation_history(session_id)
    history.append({'role': role, 'content': content})

    # é™åˆ¶å†å²é•¿åº¦
    if len(history) > MAX_HISTORY:
        history = history[-MAX_HISTORY:]

    # ä¿å­˜åˆ° Redisï¼ˆè®¾ç½® 24 å°æ—¶è¿‡æœŸï¼‰
    redis_client.setex(
        f'session:{session_id}',
        86400,  # 24 å°æ—¶
        json.dumps(history, ensure_ascii=False)
    )
```

## æ³¨æ„äº‹é¡¹

### 1. Token é™åˆ¶

- **é—®é¢˜**ï¼šå†å²å¯¹è¯è¶Šé•¿ï¼Œæ¶ˆè€—çš„ token è¶Šå¤š
- **è§£å†³æ–¹æ¡ˆ**ï¼š
  - è®¾ç½®åˆç†çš„ `MAX_HISTORY` é™åˆ¶
  - å®šæœŸæ¸…ç©ºä¸æ´»è·ƒçš„ä¼šè¯
  - ä½¿ç”¨æ‘˜è¦æŠ€æœ¯å‹ç¼©å†å²å¯¹è¯

### 2. è§†é¢‘å­˜å‚¨

- **å½“å‰å®ç°**ï¼šç”¨æˆ·è§†é¢‘å­˜å‚¨ä¸ºæ–‡æœ¬æ‘˜è¦ï¼ˆ"ç”¨æˆ·ä¸Šä¼ äº†è§†é¢‘ç‰‡æ®µ"ï¼‰
- **åŸå› **ï¼šå®Œæ•´è§†é¢‘ base64 å¤ªå¤§ï¼ˆå‡  MBï¼‰ï¼Œä¸é€‚åˆå­˜å‚¨åœ¨å†å²ä¸­
- **é™åˆ¶**ï¼šAI æ— æ³•"å›çœ‹"ä¹‹å‰çš„è§†é¢‘å†…å®¹ï¼Œåªèƒ½è®°ä½æ–‡æœ¬å“åº”

**æœªæ¥ä¼˜åŒ–æ–¹æ¡ˆï¼š**
- å°†è§†é¢‘ä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿæˆ–å¯¹è±¡å­˜å‚¨
- åœ¨å†å²ä¸­å­˜å‚¨è§†é¢‘å¼•ç”¨ URL
- éœ€è¦æ—¶é‡æ–°åŠ è½½è§†é¢‘

### 3. å†…å­˜æ³„æ¼

- **é—®é¢˜**ï¼šå†…å­˜å­—å…¸æŒç»­å¢é•¿ï¼Œä¼šè¯ä¸ä¼šè‡ªåŠ¨æ¸…ç†
- **è§£å†³æ–¹æ¡ˆ**ï¼š
  - æ·»åŠ ä¼šè¯è¿‡æœŸæœºåˆ¶ï¼ˆå¦‚ 24 å°æ—¶ï¼‰
  - ä½¿ç”¨ LRU ç¼“å­˜æ·˜æ±°æ—§ä¼šè¯
  - ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ Redis å¹¶è®¾ç½® TTL

### 4. å¹¶å‘è®¿é—®

- **é—®é¢˜**ï¼šå¤šä¸ªç”¨æˆ·åŒæ—¶è®¿é—®ï¼Œå†…å­˜å­—å…¸å¯èƒ½å‡ºç°ç«æ€æ¡ä»¶
- **è§£å†³æ–¹æ¡ˆ**ï¼š
  - ä½¿ç”¨çº¿ç¨‹é”ä¿æŠ¤å­—å…¸è®¿é—®
  - ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ Redisï¼ˆå¤©ç„¶æ”¯æŒå¹¶å‘ï¼‰

## æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯ 1ï¼šåŸºç¡€å¯¹è¯è®°å¿†

1. å¯åŠ¨ç³»ç»Ÿï¼Œè¿›å…¥è§†é¢‘é€šè¯æ¨¡å¼
2. ç¬¬ä¸€è½®ï¼šä¸Šä¼ è§†é¢‘ï¼ŒAI å›å¤"ä½ å¥½ï¼Œæˆ‘æ˜¯å¡è€åŸºæ•™ç»ƒ"
3. ç¬¬äºŒè½®ï¼šä¸Šä¼ è§†é¢‘ï¼Œæ£€æŸ¥ AI æ˜¯å¦è®°ä½ç¬¬ä¸€è½®çš„å†…å®¹
4. æŸ¥çœ‹åç«¯æ—¥å¿—ï¼Œç¡®è®¤å†å²æ³¨å…¥æˆåŠŸ

### æµ‹è¯•åœºæ™¯ 2ï¼šå†å²é™åˆ¶

1. è¿ç»­å‘é€ 25 æ¡æ¶ˆæ¯ï¼ˆè¶…è¿‡ MAX_HISTORY=20ï¼‰
2. è°ƒç”¨ `GET /api/conversation/history` æŸ¥çœ‹å†å²
3. ç¡®è®¤åªä¿ç•™æœ€è¿‘ 20 æ¡æ¶ˆæ¯

### æµ‹è¯•åœºæ™¯ 3ï¼šä¼šè¯éš”ç¦»

1. åˆ›å»ºç¬¬ä¸€ä¸ªä¼šè¯ï¼Œå‘é€å‡ æ¡æ¶ˆæ¯
2. ç‚¹å‡»"â• æ–°ä¼šè¯"åˆ›å»ºç¬¬äºŒä¸ªä¼šè¯
3. åœ¨ç¬¬äºŒä¸ªä¼šè¯ä¸­å‘é€æ¶ˆæ¯
4. ç¡®è®¤ç¬¬äºŒä¸ªä¼šè¯çš„ AI ä¸è®°å¾—ç¬¬ä¸€ä¸ªä¼šè¯çš„å†…å®¹

### æµ‹è¯•åœºæ™¯ 4ï¼šæ¸…ç©ºå†å²

1. åœ¨ä¼šè¯ä¸­å‘é€å‡ æ¡æ¶ˆæ¯
2. ç‚¹å‡»"ğŸ—‘ï¸ æ¸…ç©ºå†å²"æŒ‰é’®
3. å‘é€æ–°æ¶ˆæ¯ï¼Œç¡®è®¤ AI ä¸è®°å¾—ä¹‹å‰çš„å†…å®¹
4. ç¡®è®¤èŠå¤©è®°å½• UI å·²æ¸…ç©º

## æœªæ¥æ”¹è¿›æ–¹å‘

1. **æŒä¹…åŒ–å­˜å‚¨**ï¼šä½¿ç”¨ Redis æˆ– PostgreSQL æ›¿ä»£å†…å­˜å­—å…¸
2. **ä¼šè¯ç®¡ç† UI**ï¼šæ˜¾ç¤ºæ‰€æœ‰ä¼šè¯åˆ—è¡¨ï¼Œæ”¯æŒåˆ‡æ¢å’Œåˆ é™¤
3. **å¯¹è¯æ‘˜è¦**ï¼šè‡ªåŠ¨å‹ç¼©é•¿å¯¹è¯ï¼ŒèŠ‚çœ token
4. **è§†é¢‘å›æº¯**ï¼šæ”¯æŒ AI å›çœ‹ä¹‹å‰çš„è§†é¢‘å†…å®¹
5. **å¯¼å‡ºå¯¹è¯**ï¼šæ”¯æŒå¯¼å‡ºå¯¹è¯å†å²ä¸º PDF æˆ–æ–‡æœ¬
6. **å¤šæ¨¡æ€å†å²**ï¼šä¿ç•™è§†é¢‘ã€å›¾ç‰‡ç­‰å¤šæ¨¡æ€å†…å®¹çš„å¼•ç”¨

## ç›¸å…³æ–‡ä»¶

- **åç«¯å®ç°**ï¼š[app.py](../app.py) (lines 68-96, 1073-1221, 1370-1422)
- **å‰ç«¯å®ç°**ï¼š[static/app.js](../static/app.js) (lines 11-61, 684-686, 980-1001)
- **UI ç•Œé¢**ï¼š[static/index.html](../static/index.html) (lines 59-75)
- **æ ·å¼è¡¨**ï¼š[static/style.css](../static/style.css) (lines 162-183)

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤ GitHub Issue æˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚
